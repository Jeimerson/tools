#cloud-config

chpasswd:
  list: |
    root:passwd
  expire: False

write_files:
- encoding: b64
  content: IyEvYmluL2Jhc2gKCiMgQ29uZmlnIHZtIGlwIGFkZHJlc3MgYW5kIGRpc2sgYXV0b21hdGljYWxseS4KCiMgRmluZCBtYWluIGludGVyZmFjZSdzIG5hbWUKbmFtZT0kKGxzIC9zeXMvY2xhc3MvbmV0IHwgaGVhZCAtbiAxKQoKCiMgRmluZCBWTSBPUwppZiBbIC1mIC9ldGMvZGViaWFuX3ZlcnNpb24gXTsgdGhlbgogICAgT1NfQUNUVUFMPSQobHNiX3JlbGVhc2UgLWkgfCBjdXQgLWYyKQogICAgVkVSPSQobHNiX3JlbGVhc2UgLXIgfCBjdXQgLWYyKQoKZWxpZiBbIC1mIC9ldGMvY2VudG9zLXJlbGVhc2UgXTsgdGhlbgogICAgT1NfQUNUVUFMPUNlbnRvcwogICAgVkVSPSQoY2F0IC9ldGMvY2VudG9zLXJlbGVhc2UgfCB0ciAtZGMgJzAtOS4nfGN1dCAtZCBcLiAtZjEpCmZpCgoKCiMgVWJ1bnR1CmlmIFsgIiRPU19BQ1RVQUwiID0gVWJ1bnR1IF0gOyB0aGVuCgogICAgaWYgIFsgIiRWRVIiID0gIjE4LjA0IiBdOyB0aGVuICAgCgogICAgICAgIG1hc2syY2RyICgpCiAgICAgICAgewogICAgICAgICAgIGxvY2FsIHg9JHsxIyMqMjU1Ln0KICAgICAgICAgICBzZXQgLS0gMF5eXjEyOF4xOTJeMjI0XjI0MF4yNDheMjUyXjI1NF4gJCgoICgkeyMxfSAtICR7I3h9KSoyICkpICR7eCUlLip9CiAgICAgICAgICAgeD0kezElJSQzKn0KICAgICAgICAgICBlY2hvICQoKCAkMiArICgkeyN4fS80KSApKQogICAgICAgIH0KCiAgICAgICAgc3VibmV0PSQobWFzazJjZHIgJDMpCgogICAgICAgIGNhdCA+IC9ldGMvbmV0cGxhbi9jb25maWcueWFtbCA8PEVPTApuZXR3b3JrOgogIHZlcnNpb246IDIKICByZW5kZXJlcjogbmV0d29ya2QKICBldGhlcm5ldHM6CiAgICRuYW1lOgogICAgZGhjcDQ6IG5vCiAgICBhZGRyZXNzZXM6IFskMS8kc3VibmV0XQogICAgZ2F0ZXdheTQ6ICQyCiAgICBuYW1lc2VydmVyczoKICAgICAgYWRkcmVzc2VzOiBbJDQsJDVdCkVPTAogICAgICAgIG5ldHBsYW4gYXBwbHkKICAgICAgICAKICAgICAgICAKICAgIGVsaWYgIFsgIiRWRVIiID0gIjE2LjA0IiBdOyB0aGVuCiAgICAKICAgICAgICBjYXQgPiAvZXRjL25ldHdvcmsvaW50ZXJmYWNlcyA8PEVPTAphdXRvIGxvCmlmYWNlIGxvIGluZXQgbG9vcGJhY2sKYXV0byAkbmFtZQppZmFjZSAkbmFtZSBpbmV0IHN0YXRpYwphZGRyZXNzICQxCmdhdGV3YXkgJDIKbmV0bWFzayAkMwpkbnMtbmFtZXNlcnZlcnMgJDQKZG5zLW5hbWVzZXJ2ZXJzICQ1CmRucy1zZWFyY2ggZ29vZ2xlLmNvbQpFT0wKICAgICAgICAKICAgICAgICBzZXJ2aWNlIG5ldHdvcmtpbmcgcmVzdGFydAogICAgZmkKCiMgRGViaWFuCgplbGlmIFsgIiRPU19BQ1RVQUwiID0gRGViaWFuICBdIDsgdGhlbgoKICAgIGlmICBbICIkVkVSIiA9ICIxMCIgXTsgdGhlbgogICAgICAgIAogICAgICAgIGNhdCA+IC9ldGMvbmV0d29yay9pbnRlcmZhY2VzIDw8RU9MCmF1dG8gbG8KaWZhY2UgbG8gaW5ldCBsb29wYmFjawphdXRvICRuYW1lCmlmYWNlICRuYW1lIGluZXQgc3RhdGljCmFkZHJlc3MgJDEKZ2F0ZXdheSAkMgpuZXRtYXNrICQzCmRucy1uYW1lc2VydmVycyAkNApkbnMtbmFtZXNlcnZlcnMgJDUKZG5zLXNlYXJjaCBnb29nbGUuY29tCkVPTAogICAgICAgIAogICAgICAgIHNlcnZpY2UgbmV0d29ya2luZyByZXN0YXJ0CiAgICAgICAgCiAgICAgICAgY2F0ID4gL2V0Yy9yZXNvbHYuY29uZiA8PEVPTApuYW1lc2VydmVyICQ0Cm5hbWVzZXJ2ZXIgJDUKc2VhcmNoIGdvb2dsZS5jb20KRU9MICAgICAgIAogICAgCiAgICBmaQoKIyBDZW50b3MKZWxpZiBbICIkT1NfQUNUVUFMIiA9IENlbnRvcyAgXSA7IHRoZW4KCiAgICBpZiAgWyAiJFZFUiIgPSAiOCIgXTsgdGhlbgogICAgICAgIAogICAgICAgIGNhdCA+IC9ldGMvc3lzY29uZmlnL25ldHdvcmstc2NyaXB0cy9pZmNmZy0kbmFtZSA8PEVPTApERVZJQ0U9JG5hbWUKVFlQRT1FdGhlcm5ldApPTkJPT1Q9eWVzCklQQUREUj0kMQpHQVRFV0FZPSQyCk5FVE1BU0s9JDMKRE5TMT0kNApETlMyPSQ1CkVPTAogICAgICAgIAogICAgICAgIHN5c3RlbWN0bCByZXN0YXJ0IE5ldHdvcmtNYW5hZ2VyCiAgICAgICAgICAgICAgICAgICAgCiAgICBmaQoKZmkKCgoKIyBGaW5kIHZpcnR1YWxpemF0aW9uIHN5c3RlbSBhbmQgY2hhbmdlIHBhc3N3b3JkIGFuZCBleHRlbmQgZGlzawoKdmlydHVhbGl6YXRpb249JChzeXN0ZW1kLWRldGVjdC12aXJ0KQoKaWYgWyAkdmlydHVhbGl6YXRpb24gPSB2bXdhcmUgXSA7IHRoZW4KICAgIGlmIFsgJDYgPSB5ZXMgXTsgdGhlbgogICAgICAgIAogICAgICAgIGlmIFsgIiRPU19BQ1RVQUwiID0gRGViaWFuICBdIDsgdGhlbgogICAgICAgIAogICAgICAgICAgICBjYXQgPiAvZXRjL2FwdC9zb3VyY2VzLmxpc3Q8PEVPTApkZWIgaHR0cDovL2RlYi5kZWJpYW4ub3JnL2RlYmlhbi8gc3RhYmxlIG1haW4gY29udHJpYgpkZWItc3JjIGh0dHA6Ly9kZWIuZGViaWFuLm9yZy9kZWJpYW4vIHN0YWJsZSBtYWluIGNvbnRyaWIKZGViIGh0dHA6Ly9kZWIuZGViaWFuLm9yZy9kZWJpYW4vIHN0YWJsZS11cGRhdGVzIG1haW4gY29udHJpYgpkZWItc3JjIGh0dHA6Ly9kZWIuZGViaWFuLm9yZy9kZWJpYW4vIHN0YWJsZS11cGRhdGVzIG1haW4gY29udHJpYgpkZWIgaHR0cDovL2RlYi5kZWJpYW4ub3JnL2RlYmlhbi1zZWN1cml0eSBzdGFibGUvdXBkYXRlcyBtYWluCmRlYi1zcmMgaHR0cDovL2RlYi5kZWJpYW4ub3JnL2RlYmlhbi1zZWN1cml0eSBzdGFibGUvdXBkYXRlcyBtYWluCmRlYiBodHRwOi8vZnRwLmRlYmlhbi5vcmcvZGViaWFuIGJ1c3Rlci1iYWNrcG9ydHMgbWFpbgpkZWItc3JjIGh0dHA6Ly9mdHAuZGViaWFuLm9yZy9kZWJpYW4gYnVzdGVyLWJhY2twb3J0cyBtYWluCkVPTAoKICAgICAgICAgICAgYXB0IHVwZGF0ZSAmJiBhcHQgaW5zdGFsbCBwYXJ0ZWQgbHZtMiAteQogICAgICAgIGZpCiAgICAgICAgCiAgICAgICAgaWYgWyAtZSAvZGV2L3NkYTIgXTsgdGhlbgogICAgICAgICAgICBzZGE9MwogICAgICAgIGVsc2UKICAgICAgICAgICAgc2RhPTIKICAgICAgICBmaQogICAgICAgIAogICAgICAgIGlmICBbICIkVkVSIiA9ICIxNi4wNCIgLW8gIiRPU19BQ1RVQUwiID0gRGViaWFuIF07IHRoZW4KICAgICAgICAgICAgcGFydGVkIC9kZXYvc2RhIC0tc2NyaXB0IG1rcGFydCBwcmltYXJ5ICIkKHBhcnRlZCAvZGV2L3NkYSBwcmludCB8IGdyZXAgLUUgImx2bSIgfCBhd2sgJ3twcmludCAkM30nKSAxMDAlIgogICAgICAgIGVsc2UKICAgICAgICAgICAgcGFydGVkIC9kZXYvc2RhIC0tc2NyaXB0IG1rcGFydCBwcmltYXJ5ICIkKHBhcnRlZCAvZGV2L3NkYSBwcmludCB8IGdyZXAgLUUgImx2bXxleHRlbmRlZCIgfCBhd2sgJ3twcmludCAkM30nKSAxMDAlIgogICAgICAgIGZpCiAgICAgICAgCiAgICAgICAgcHZzY2FuIC0tY2FjaGUKICAgICAgICBwYXJ0cHJvYmUKICAgICAgICB2Zz0kKHZncyAtLW5vaGVhZGluZ3MgfCBhd2sgJ3twcmludCAkMX0nKQogICAgICAgIHB2Y3JlYXRlIC9kZXYvc2RhJHNkYQogICAgICAgIHZnZXh0ZW5kICIkdmciIC9kZXYvc2RhJHNkYQogICAgICAgIGx2ZXh0ZW5kIC9kZXYvIiR2ZyIvcm9vdCAvZGV2L3NkYSRzZGEKICAgICAgICAKICAgICAgICBpZiBbIC1mIC9ldGMvZGViaWFuX3ZlcnNpb24gXTsgdGhlbgogICAgICAgICAgICByZXNpemUyZnMgL2Rldi8iJHZnIi9yb290CiAgICAgICAgICAgIAogICAgICAgIGVsaWYgWyAiJE9TX0FDVFVBTCIgPSBDZW50b3MgIF0gOyB0aGVuCiAgICAgICAgICAgIGlmICBbICIkVkVSIiA9ICI4IiBdOyB0aGVuICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgeGZzX2dyb3dmcyAvCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB4ZnNfZ3Jvd2ZzIC9kZXYvIiR2ZyIvcm9vdCAKICAgICAgICAgICAgZmkKICAgICAgICBmaQogICAgZmkKZmkgCg==
  owner: root:root
  path: /root/autovm.sh
  permissions: '0644'
  
runcmd:
- sh /root/autovm.sh 192.168.1.2 192.168.1.1 255.255.255.0 4.2.2.4 8.8.8.8 no
- sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin yes/' /etc/ssh/sshd_config
- service sshd restart

hostname: autovm

# test
phone_home:
  url: http://autovm/site/default/webhook
  post: [ pub_key_dsa, pub_key_rsa, pub_key_ecdsa, instance_id ]
